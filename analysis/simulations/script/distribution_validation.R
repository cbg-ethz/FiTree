library(ggplot2)
library(dplyr)
library(tidyr)
library(parallel)
library(ggpubr)
library(latex2exp)
library(copula)

color_palette <- c(
    "#3399CC", "#e7753c", "#F1C40F","#257637", 
    "#9d3ec5", "#ad7e98", "#281fa1", "#40d5baa2")


############### plot settings

df_setting <- data.frame(matrix(ncol = 5, nrow = 0))
df_setting <- rbind(
    df_setting,
    c("A", "Root", "No", 0.0, 0.001),
    c("A", "X_1", "No", 0.7, 0.001),
    c("A", "X_2", "No", -0.5, 0.01),
    c("A", "X_3", "No", 1.1, 0.01),
    c("B", "Root", "No", 0.0, 0.001),
    c("B", "X_1", "No", 0.7, 0.001),
    c("B", "X_2", "No", 1.1, 0.01),
    c("B", "X_3", "No", -0.5, 0.01),
    c("C", "Root", "No", 0.0, 0.001),
    c("C", "X_1", "No", 0.7, 0.001),
    c("C", "X_2", "No", 0.7, 0.01),
    c("C", "X_3", "No", 0.7, 0.01),
    c("D", "Root", "No", 0.0, 0.001),
    c("D", "X_1", "No", 0.7, 0.001),
    c("D", "X_2", "No", 1.1, 0.001),
    c("D", "X_3", "No", -0.5, 0.001),
    c("E", "Root", "Yes", 0.0, 0.001),
    c("E", "X_1", "Yes", 0.7, 0.001),
    c("E", "X_2", "Yes", -0.5, 0.01),
    c("E", "X_3", "Yes", 1.1, 0.001),
    c("F", "Root", "No", 0.0, 0.001),
    c("F", "X_1", "No", 0.0, 0.001),
    c("F", "X_2", "No", 1.1, 0.01),
    c("F", "X_3", "No", 1.2, 0.01),
    c("G", "Root", "No", 0.0, 0.001),
    c("G", "X_1", "No", -0.5, 0.001),
    c("G", "X_2", "No", 1, 0.01),
    c("G", "X_3", "No", 1.2, 0.01)
)

colnames(df_setting) <- c("setting", "type", "branching", "lambda", "nu")
df_setting$lambda <- as.numeric(df_setting$lambda)
df_setting$nu <- as.numeric(df_setting$nu)

# Step 1: Filter out the rows for setting 'E'
df_setting_E <- subset(df_setting, setting == "E")

# Step 2: Define the paths for setting 'G'
# Path from X_1 to X_2 and X_1 to X_3
paths_E <- rbind(
    df_setting_E[df_setting_E$type == "Root", ],
    df_setting_E[df_setting_E$type == "X_1", ],
    df_setting_E[df_setting_E$type == "X_1", ],
    df_setting_E[df_setting_E$type == "X_2", ],
    df_setting_E[df_setting_E$type == "X_1", ],
    df_setting_E[df_setting_E$type == "X_3", ]
)
paths_E$group <- c(1, 1, 2, 2, 3, 3)  # Define groups to separate the lines


# plot df_setting with type as the x-axis
# lambda as the y-axis,
# setting as the color,
# nu as the shape
pd <- position_dodge2(width = c(0.000000001, 0.3, 0.3, 0.3))
g <- ggplot(df_setting %>% filter(setting != "E")) +
    geom_point(
        data = df_setting %>% filter(setting != "E", type != "Root"),
        mapping = aes(
            x = type, 
            y = lambda, 
            color = setting, 
            shape = as.factor(nu)
        ),
        size = 6,
        alpha = 0.6,
        position = position_dodge2(width = c(0.3, 0.3, 0.3))
    ) +
    geom_point(
        data = paths_E %>% filter(type != "Root"),
        mapping = aes(
            x = type, 
            y = lambda, 
            color = setting, 
            shape = as.factor(nu)
        ),
        size = 6,
        alpha = 0.6,
        position = position_nudge(x = 0.06)
    ) +
    geom_path(
        mapping = aes(
            x = type, 
            y = lambda, 
            color = setting, 
            group = setting,
            linetype = branching
        ),
        linewidth = 1,
        alpha = 0.6,
        position = position_dodge2(width = c(0.000000001, 0.3, 0.3, 0.3))
    ) +
    geom_path(
        data = paths_E,
        mapping = aes(
            x = type, 
            y = lambda, 
            color = setting, 
            group = group,
            linetype = branching
        ),
        linewidth = 1,
        alpha = 0.6,
        position = position_nudge(x = 0.06)
    ) +
    # Plot a single root point (without showing it in the legend)
    geom_point(
        data = data.frame(type = "Root", lambda = 0),
        mapping = aes(
            x = type,
            y = lambda
        ),
        size = 6,
        color = "darkgrey",  # Use a single color for the root
        shape = 16,  # Use a circle for the root
        show.legend = FALSE  # Prevent it from appearing in the legend
    ) +
    scale_shape_manual(values=c(15, 17)) +
    scale_color_manual(
        values = c(
            "A" = color_palette[1],
            "B" = color_palette[2],
            "C" = color_palette[3],
            "D" = color_palette[4],
            "E" = color_palette[5],
            "F" = color_palette[6],
            "G" = color_palette[7],
            "H" = color_palette[8]
        ),
        labels = c(
            "A" = "A",
            "B" = "B",
            "C" = "C",
            "D" = "D",
            "E" = "E",
            "F" = "F",
            "G" = "G",
            "H" = "H"
        ),
        guide = "legend",
        labs(title = "Setting")
    ) +
    scale_x_discrete(
        labels = c(
            "Root" = "Root",
            "X_1" = TeX("$C_1$"),
            "X_2" = TeX("$C_2$"),
            "X_3" = TeX("$C_3$")
        )
    ) +
    scale_linetype_manual(
        values = c(
            "No" = 1,
            "Yes" = 4
        ),
        labels = c(
            "No",
            "Yes"
        ),
        guide = "legend", 
        labs(title = "Branching")
    ) +
    labs(
        x = "Cell type",
        y = TeX("Net growth rate $\\lambda$"),
        # title = "Parameter settings",
        shape = TeX("Mutation rate $\\nu$"),
        linetype = "Branching"
    ) +
    theme(
        title = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 20),
        axis.text.x = element_text(size = 18),
        axis.text.y = element_text(size = 18),
        legend.position = "right",
        legend.box = "vertical",
        legend.box.just = "left",
        legend.justification = "left"
    ) +
    guides(
        color = guide_legend(nrow = 2),   # Keep color legend in one row
        shape = guide_legend(nrow = 1),
        linetype = guide_legend(nrow = 1)
    )


ggsave(
    plot = g,
    filename = "/Users/luox/Documents/Projects/FiTree/figures/parameter_settings.pdf",
    width = 10,
    height = 4
)

###################### plot distributions

df_all <- read.csv("demo/simulations/data/subclone_sizes.csv")
df_sampling_all <- read.csv("demo/simulations/data/sampling_times.csv")

t <- 20
g1 <- ggplot(data = df_all) +
    stat_ecdf(
        mapping = aes(
            x = X_1 + 1, 
            color = setting,
            lty = "Simulation"
        ), 
        geom = "step"
    ) +
    stat_function(
        mapping = aes(
            x = as.numeric(X_1 + 1),
            color = "A", 
            lty = "Theory"),
        fun = function(x) {
            pgamma(
                x * exp(-0.7 * t),
                shape = 0.7,
                rate = 0.7
            )
        },
        linewidth = 1.5
    ) +
    stat_function(
        mapping = aes(
            x = as.numeric(X_1 + 1),
            color = "B", 
            lty = "Theory"),
        fun = function(x) {
            pgamma(
                x * exp(-0.7 * t),
                shape = 0.7,
                rate = 0.7
            )
        },
        linewidth = 1.5
    ) +
    stat_function(
        mapping = aes(
            x = as.numeric(X_1 + 1),
            color = "C", 
            lty = "Theory"),
        fun = function(x) {
            pgamma(
                x * exp(-0.7 * t),
                shape = 0.7,
                rate = 0.7
            )
        },
        linewidth = 1.5
    ) +
    stat_function(
        mapping = aes(
            x = as.numeric(X_1 + 1),
            color = "D", 
            lty = "Theory"),
        fun = function(x) {
            pgamma(
                x * exp(-0.7 * t),
                shape = 0.7,
                rate = 0.7
            )
        },
        linewidth = 1.5
    ) +
    stat_function(
        mapping = aes(
            x = as.numeric(X_1 + 1),
            color = "E", 
            lty = "Theory"),
        fun = function(x) {
            pgamma(
                x * exp(-0.7 * t),
                shape = 0.7,
                rate = 0.7
            )
        },
        linewidth = 1.5
    ) +
    stat_function(
        mapping = aes(
            x = as.numeric(X_1 + 1),
            color = "F", 
            lty = "Theory"),
        fun = function(x) {
            pgamma(
                x / t,
                shape = 0.7 / 0.3,
                rate = 1 / 0.3
            )
        },
        linewidth = 1.5
    ) +
    stat_function(
        mapping = aes(
            x = as.numeric(X_1 + 1),
            color = "G", 
            lty = "Theory"),
        fun = function(x) {
            pnbinom(
                (x - 1),
                size = 1.0,
                prob = 0.5/1.2
            )
        },
        linewidth = 1.5
    ) +
    scale_color_manual(
        values = c(
            "A" = color_palette[1],
            "B" = color_palette[2],
            "C" = color_palette[3],
            "D" = color_palette[4],
            "E" = color_palette[5],
            "F" = color_palette[6],
            "G" = color_palette[7],
            "H" = color_palette[8]
        ),
        labels = c(
            "A" = "A",
            "B" = "B",
            "C" = "C",
            "D" = "D",
            "E" = "E",
            "F" = "F",
            "G" = "G",
            "H" = "H"
        ),
        guide = "legend",
        labs(title = "Setting")
    ) +
    scale_linetype_manual(
        values = c(
            "Simulation" = 1,
            "Theory" = 4
        ),
        labels = c(
            "Simulation",
            "Theory"
        ),
        guide = "legend",
        labs(title = "Method")
    ) +
    labs(
        x = TeX(
            sprintf(
                paste0(
                    "Number of cells ",
                    "($C_1(t)$, t = %s)"
                ),
                t
            )
        ),
        y = "Cumulative probability"
    ) +
    scale_x_log10() +
    theme(
        legend.title = element_text(size = 16),
        legend.text = element_text(size = 14),
        axis.title = element_text(size = 16),
        axis.text = element_text(size = 14),
        plot.title = element_text(size = 16)
    ) + 
    coord_cartesian(xlim = c(3, 2e7)) +
    guides(
        color = guide_legend(nrow = 1),   # Keep color legend in one row
        shape = guide_legend(nrow = 1),
        linetype = guide_legend(nrow = 1)
    )


B_cdf_df_X2 <- data.frame(
    N = 10^(seq(0, 12, 0.5)),
    cdf = c(
    0.0005848155299404532279010885688835265285567979389052150881063130881984782384785058163363423198327573736,
 0.0009766534613647379282741089358902620644457313574621384174599778536809226256237032570632816575171941273,
 0.001631007496336337372715032424810690423648858950886836393376934144687832609014282620228491458798865254,
 0.002723696175042504397722053804916039983863102676644019514168304707969448604991233036801308901492661044,
 0.004548150427361238916248354995424016800519874033983236079911175135053497028870985446916345358634346544,
 0.007593740731595075524577043471483686991282790319408571615865294973482891412214128792596112669939829751,
 0.01267540630599448913057834610779369439626514333797028968908895388688235086702722707748686836714518388,
 0.02114605542449477301088985382483149066537748372245125525506151470872692086970056898975157094758858902,
 0.03523719900164186372002800382296071378861768563838669574932894236462087462844686278706763224048808704,
 0.05857969559545618536045769626684868659586144563908214801366317080785877834215890106280708177775570043,
 0.09691192173021958694170470025035232167001745295185931500847293668417153272097593489855433783796432471,
 0.1587410176973021405545908598469421199163524272055438884839020718697044322584575393158955191494116797,
 0.2548984591519132523203905034438471776497033544162342632329775545375539713277147982099768502176899243,
 0.3940024338030271297548655851753540599307523624113228106777787989511306160628217304246851707974191972,
 0.5695492380992995694733027617487900940494348926392046615719729090209361506048125668511703594543033035,
 0.7451609593067174991679106746108619240993196794823139009835690576343121901984257870621730275042664112,
 0.8725013080905319807999302663816297649841321217606923292264088657538552289754531402124037593077682412,
 0.9407503965952111171262552431668906142471758366625374994411256761708415625072407241930223784034472482,
 0.9724615193144104918959183483029901021601139585335375416399203665190462722884622164918753575201708896,
 0.9870194774988580531123983183576348852706814887692032841390414738666960084345884315416721633816632771,
 0.9938230099695208487310168240182683941842100973970545388971229864817585844767061537906095035107385053,
 0.9970456607343272498194827377996799697602256440296428611215372939214264393285416511358874202014301069,
 0.9985834185658711356033263159682009529602726594309794891388385608856299249114568645383557901600606782,
 0.9993199217606554104394892028530612334409345884705863368767169040588345961294387098213263099854406335,
 0.999673310041634193401695883826084425215752586041159525612141764721458794302233455661353314775407956
 )
 )

D_cdf_df_X2 <- data.frame(
N = 10^(seq(0, 12, 0.5)),
cdf = c(
0.002930701747871698649897545992335660666930738128401668941774236121220896297259999619126206338177221298,
0.004893754107933388007831910882526772694060690629479710252589944005668497244511977817038828068112412128,
0.008170551299246745299280481706005800981898523049876105448369673039181385762179033381920239823090160991,
0.01363744782080988558081239569544335711220433433555504902512773116912854963440214474678702413269937674,
0.02274835104868065943735452137309210390780433560507801134281413091695759748459860587492862893531052151,
0.03789804953156154870016656271279884672079095966724733620527841972357535087694978834715035849555844285,
0.06297169052452575948589803322109527787651361238972489606923817567972041697696525758306623311199894868,
0.1040709156563731814675660115900540358015610863110684454974452394861562679141552280279927542511641587,
0.1701133029432595446671466402435814804834339047195957798796724413794464646193131115155626248009501887,
0.2720452112720361224891015240113914007716785361069539028091700489950402190774995876026506927948630569,
0.4173379417927871027703358253941617833648755315880626382969837138111056187155203278781671143320516639,
0.5958551810828237145581031392231567529203125199099087695780537589678027421600309634446012397063879759,
0.7671448451521610905877060592758902327077284974074217079731687171882629194585523520762067913358784181,
0.885492438244954123794981233685878991879899863992728201205695441714993712748168673970700896911867121,
0.9469352794184382931278281910409593212054142462231262605478998761535744608430234036287007628960028984,
0.9752867701009289780997839896971066035978127932422929896794039125650933258488489646524609744899237172,
0.9883313532186869704306725188342930983991364986614672978507321569347973280252671947946290422432376644,
0.9944420277357871525624727823246349188884242435395389961065663802836994822112675456528100330637881511,
0.9973404513291348374890775605722306091354123534463391920924239732991168020833658296706893077218092564,
0.9987244681995415438768694195150690365828480052740308370893415768628637726116657262901527800892366437,
0.9993875675464860928466005558681474123684092060940051320429675387946355674611957678281361817714226001,
0.9997057889133436243566566436766035468501796675580694725740383529542635744038925717615344973202506517,
0.9998586249894064736036709412080721482807792617418047999970735498518806622722911482300556673827815644,
0.9999320576520976347566525638249538703433290375433922939161786183983346868497156346983472130288851182,
0.9999673461374699763420292537881703786377427136571180441017187247959458156345672591080125664003442642
)
)


F_cdf_df_X2 <- data.frame(
    N = 10^(seq(0, 12, 0.5)),
    cdf = c(
    0.4121423163265603050316292509336929674682685560750296744907322897260239144333035178485076737612366125,
 0.4451796474193362123154449167847510274353396589377138094494668732116390224028639109542598243403655123,
 0.4800184128790649964715790520714365298679459331595581901923092287058883019886302863159726830965697373,
 0.5165360189901970528851238711592068466035452882270862438608304381884094813796142905757591631688317151,
 0.554552493091554544173457911268322574127358253400662954616329512291764905793107134465427847431442004,
 0.5938236386823751739795254896856976215316171693268262855320505076925326762806105671514977164059476094,
 0.6340354758019152402685636541425458109984385438443830951180627603248275553891633812612005864074915405,
 0.6748007017910122987120212799767995402179345539179250716532373639711393947517183587238027772722548043,
 0.7156579718711472515873591359079013406907344327615162269423432108024696951999612132801527711040747401,
 0.756074798866565574501225116089952605467766815194879664276592395958626725077155440264095954301727655,
 0.7954547838636073914345339660017095363148871733319320591078528886255934842656594964323759369197347799,
 0.8331497011635136901922636156114035200170608219571139673171057450565350923049226446593935905274798708,
 0.8684766842223114294354569818469839949574741956991510587885526329359301931345101770219449599128681582,
 0.9007404731993096887652435729414645891874252097345189896324205794999414661975842266846023214392582117,
 0.9292606454378790288960745147489610989209382807201575356132468998579016178882526665814024899506229018,
 0.9534047229025407905553664093647177138831545703072831303244709595189357965929834860852553146586043793,
 0.9726322868042685019706672438001054951592237495509964650336390062168507144853725445738220358049970031,
 0.9865689884572049511076964692469319129991696227459354091541964057851563415581975142104386823547274386,
 0.9951658703793249375764700932774967436005740163921437514992835493449719649669507284349633073790080979,
 0.9990498691871954229172884174711105063279374132168707536679783205695053803421850105793771934119173422,
 0.9999523718166353575909935594995062637506775543533751466164236855880234632349463692359010603627368724,
 0.9999999334731964973179564147281721053347095469923796900271446045290387634126044693618127543767257095,
 0.999999999999997438903313406575275500984817234354407504528241021121088958937398490243904480960025807,
 0.999999999999999999999999999999999999271410827232369279037923090698689945619473712832429830588478812,
 1.0
 )
 )



G_cdf_df_X2 <- data.frame(
    N = 10^(seq(0, 12, 0.5)),
    cdf = c(
    0.8265183828346628862392493717666608714604370564601529997840833316027120178802704511445523083565080509,
 0.8368279685655689436158817507927063271419272021595447351471387190142309472712367779246361395122328443,
 0.8472662745373898122867281827231978305235740424451118649036648034529358964644908677409520253262502416,
 0.8578349083447887904462325600715360235461561999187632450399080108470451265480996827219767498267400728,
 0.8685354952825050249578709613076835019462564933066732262560237015560864907411009665403239965226210872,
 0.8793696732602040346130927293947357826960210902294737209011301274225140736702193506357153167818946218,
 0.8903390759695111327941038663997331858895960071300085772088577853330595491609814734339373112339822258,
 0.90144527843160822074154706134071793193931573916698826232057986099804042180624102687456178767968941,
 0.912689622101548056946978576730933762726023703852744066828965188783373122033864569842862442086065812,
 0.9240726544588236104829699511805353545765041011160778582211011766083993902483851927333288565149553556,
 0.9355923355253759224487553379845435897230096143884591357690506358102894225483499780459779334648934185,
 0.9472383091008291804125998523267891293496640968347233746656644494563358571294831080644977511253313318,
 0.9589737025987604867686208402209678865076752890882746239771994748555409084733173388906639771014775218,
 0.9706782822385823168951355207931944470452787531894407371001176720422892997756770859720952679050392961,
 0.9819804336110586851976850018820834301723511970694657775949760278285270982960422097690769451520304543,
 0.9918465819880464506225465067881980968233777752755627294311968529578319396834150948143805619823457888,
 0.9981931153653226140192045053146343571681162363769311054830149728991893687483956875840256396474452409,
 0.9999403557004620048174826263948493953463279882382450758812348965552495368277398336702561440872545472,
 0.9999999928083140410611037289848478686864010550485667904310006829057370722016174911442550168348122883,
 0.9999999999999999999758774674204101083731113714428761455244513024989479787231427650967111990340909981,
 0.9999999999999999999999999999999999999999999999999999998724831006644887291742302326014904789390607645,
 1.0,
 1.0,
 1.0,
 1.0
 )
 )

g2 <- ggplot(data = df_all) +
    stat_ecdf(
        mapping = aes(
            x = X_2 + 1, 
            color = setting,
            lty = "Simulation"
        ), 
        geom = "step"
    ) +
    stat_function(
        mapping = aes(
            x = as.numeric(X_2 + 1),
            color = "A", 
            lty = "Theory"
        ),
        fun = function(x) {
            pgamma(
                x * exp(-0.7 * t),
                shape = 0.7,
                rate = 0.7 / (0.01 / 1.2)
            )
        },
        linewidth = 1.5
    ) +
    stat_function(
        mapping = aes(
            x = as.numeric(X_2 + 1),
            color = "E", 
            lty = "Theory"
        ),
        fun = function(x) {
            pgamma(
                x * exp(-0.7 * t),
                shape = 0.7,
                rate = 0.7 / (0.01 / 1.2)
            )
        },
        linewidth = 1.5
    ) +
    geom_line(
        data = B_cdf_df_X2,
        mapping = aes(x = N, y = cdf, colour = "B", lty = "Theory"),
        linewidth = 1.5
    ) +
    stat_function(
        mapping = aes(
            x = as.numeric(X_2 + 1),
            color = "C", 
            lty = "Theory"),
        fun = function(x) {
            pgamma(
                x * exp(-0.7 * t) / t,
                shape = 0.7,
                rate = 0.7 / 0.01
            )
        },
        linewidth = 1.5
    ) +
    geom_line(
        data = D_cdf_df_X2,
        mapping = aes(x = N, y = cdf, colour = "D", lty = "Theory"),
        linewidth = 1.5
    ) +
    geom_line(
        data = F_cdf_df_X2,
        mapping = aes(x = N, y = cdf, colour = "F", lty = "Theory"),
        linewidth = 1.5
    ) +
    geom_line(
        data = G_cdf_df_X2,
        mapping = aes(x = N, y = cdf, colour = "G", lty = "Theory"),
        linewidth = 1.5
    ) +
    scale_color_manual(
        values = c(
            "A" = color_palette[1],
            "B" = color_palette[2],
            "C" = color_palette[3],
            "D" = color_palette[4],
            "E" = color_palette[5],
            "F" = color_palette[6],
            "G" = color_palette[7],
            "H" = color_palette[8]
        ),
        labels = c(
            "A" = "A",
            "B" = "B",
            "C" = "C",
            "D" = "D",
            "E" = "E",
            "F" = "F",
            "G" = "G",
            "H" = "H"
        ),
        guide = "legend",
        labs(title = "Setting")
    ) +
    scale_linetype_manual(
        values = c(
            "Simulation" = 1,
            "Theory" = 4
        ),
        labels = c(
            "Simulation",
            "Theory"
        ),
        guide = "legend",
        labs(title = "Method")
    ) +
    labs(
        x = TeX(
            sprintf(
                paste0(
                    "Number of cells ",
                    "($C_2(t)$, t = %s)"
                ),
                t
            )
        ),
        y = "Cumulative probability"
    ) +
    scale_x_log10() +
    theme(
        legend.title = element_text(size = 16),
        legend.text = element_text(size = 14),
        axis.title = element_text(size = 16),
        axis.text = element_text(size = 14),
        plot.title = element_text(size = 16)
    ) +
    coord_cartesian(xlim = c(4, 1e11)) +
    guides(
        color = guide_legend(nrow = 1),   # Keep color legend in one row
        shape = guide_legend(nrow = 1),
        linetype = guide_legend(nrow = 1)
    )


A_cdf_df_X3 <- data.frame(
    N = 10^(seq(0, 12, 0.5)),
    cdf = c(
    0.01666560461812207120204594869594595038269164832859354411843118091898096689721439430802564010269298266,
 0.02778872058717212396611399257574491181650834732150735200210151189987894083393554017772209018160742121,
 0.046257746794840059274004902147765068863080211821434822179566540240189944686838801155099720489976334,
 0.07673408240006299155256142028598638831076234230079142839509620409659837244227665057287478363935313574,
 0.1263830262577309427906182184589385981692671313449088293077600394141753431366160423838190976540785899,
 0.2051694654457468994278471754184997967242211727330758942315398218684749272712767317803460887579900365,
 0.3237591702461825064752251992880472829495298861780367612362880423757055565732729856552722749408340409,
 0.4848676998609808305560099609246192213743501636697008050108178644621236404482633886453288912055213715,
 0.6668308900084577642864765171858563597120141989496383311176572566338433928170536618627059845652419577,
 0.8211757788751095499251799964830421904861850261692832398977457572334151971295070115320342966900319341,
 0.9151269654063408265422609638208584433003509747345760896088771169671630247357885278894254404948397565,
 0.9607320501497972515751597843414428874333841734025544962564814778197153986448887301923387874225424593,
 0.9816066447559820727060325976356233411647695401732951656768251511896288828494070859442915897656751607,
 0.9912800137704513266874730419896015630865361859354265135364603686521838470326725871876168521227553512,
 0.9958374611592771712477641399737572048002364588071741933767941794567735267206895550604576413684126272,
 0.9980060062321822232404593102997631289830837235963854827813329488538251844007324494980339518757961006,
 0.9990431609655349712028637966593722850087021378566902649670444205998090792162999504059183935304080272,
 0.9995404655879918373989122120450617396051039636467240706851837323294841306676418140681121044764831816,
 0.9997792132419331894354212304985741439432962509047245215723166287204622934718389381985789670171043913,
 0.9998939006537203856569267242115822989801331111960706960437693776222259073851774880030133517940296639,
 0.9999490090447006456544659428242898791522215544145588744946684539371593572236030815874225692641399548,
 0.9999754928286546341609005179288048231662819130760202766997396219177777710073779254050008163901512694,
 0.9999882211565931300575244627359925810310213876311272426959807719197334165986166799221625702331209323,
 0.9999943386938886595153698540106490144668397337617250412297719493012276721410995651567253022513292191,
 0.9999972789732879525839876167857325792724136585246330235060682794800069933802251035657358047806765013
 )
 )



B_cdf_df_X3 <- data.frame(
    N = 10^(seq(0, 12, 0.5)),
    cdf = c(
    0.00560695003703559659217234937173574062393623884150494777290058733957442930470848683591999972906552664,
 0.009360748497209294107998711643537620809812160845403655489800656025494204596427053946085669755250527259,
 0.01562210913700027018216729699335204055648656480448975858292550285046730883584603045118518081974091626,
 0.02605236362985935016854570453023167352653707025884311610270198258960128056200567103634104327807682597,
 0.04337978060364770319543063893840919623721797155173477091946344247530496149128617967500672339331108041,
 0.07200250519446422734262855090064414393263984510340728829008687874810535716586205052772939565522959291,
 0.1187332201241553800351580453515932802741139749376826977671579893467424335434823242357187211324289135,
 0.1932180246107518700724989382238947201894947445997097716717400010547437536798954705583835633300387966,
 0.3063265802962547647263572354691451293690767284688469108905261882896159352281696993156059691577469627,
 0.4625878271339205596128037329924312164912972136805121984990466582968699337764535986031208912957189201,
 0.6442582772490221513957614503578824195964662050783599165846020569438938552028471057854285582544565407,
 0.8048059140095966125179794620248572021021061038134120031726861229897547310512924110101671380509555927,
 0.9064693875952727894924341661811609051213593021054804316626263471064472894735186649875004341172437945,
 0.9567373735342731655209273821392204806035061072807712513980121901938174615482970422975441199457077703,
 0.9797729575730835210672684445893367748770928863146287904606617007404563346542762275762744210276547959,
 0.9904223314570645576195047316519847546636840491650604707442813094922405562333031097930722668518616773,
 0.9954309724630100314751674346431048804600847595094434902587500244589471258312484995242571726808838898,
 0.9978119838055130431996739836295561722811681128641147596415319434091675292074517891446132032417664411,
 0.9989502209291370487609051596512142993987679521436712707220251712338509610127073024351574121816458289,
 0.9994958679654372138580166503915313750110053877895309950498101989661228064907143098619230348450429518,
 0.9997577947919289588900526672169182655348580827201119615255453856758316592311416805247790413024369018,
 0.9998836100299219612547742311882529321616952146656460501208821306626466861261416601414471751240956912,
 0.9999440638800008747831918565593306048392678969813552374839370904396789441374676215640369723857238317,
 0.9999731162023400691825554876279690010028676638114533914619818767959394976630279236859659437587020446,
 0.9999870789075661835339313431328028158286730019184736497239337662243055744435662463474646479897708624
 )
 )


D_cdf_df_X3 <- data.frame(
    N = 10^(seq(0, 12, 0.5)),
    cdf = c(
    0.0773750709693915464890919996754346688042974821935124322372217732862133033471373173312995791974302516,
 0.1274175931427025653705182976882593420637682091802245568537969774532607311498408891083379808067553467,
 0.20678023083790236411945271207880383486889885388207195279216216752219991678042633321836426901756685,
 0.3260926944429342967409581785601528375971396124596236850997048368451480216328079501919093817571978262,
 0.4878122998675465316421751177238372930142276739869195446011256084631215824724481160742757085798051081,
 0.669752300450631109943828694326652168804195462756902949952903108702094089488333548532467110163225021,
 0.8232406575554959766704259726172557727353015676251486073006479092888015574469972742285216896854506327,
 0.9162007483324243134477266268418018115132338989416477611025596926464701787544859528787807408077752795,
 0.9612259374968787729047390112635518686705887732447905775398121156609762590356380463735938222978095653,
 0.9818336432938542984836732717918009272369292559388815147572960835791473106812414048755918573706637633,
 0.9913863177161175572742986997444627097796658976153349319151626614145870688745771658140713722891577743,
 0.9958878774343547472355215230950519507504954715212788686871503246397472360636888475329152685285632649,
 0.9980300790659672478622455549506013582850950685160078212597260296453980895044219548920453576673089183,
 0.9990546942652253832999902179824291553939066900835399932228999815888239181659578670057448872791480062,
 0.9995460003523280376689575722840640325629162585553796022340961820662467920633457256753736923840906922,
 0.9997818714758407022856341317161367158065513878492987831441879550978188842795818280382136126643542782,
 0.9998951778433947267874779545716852367809916313031266095473909192947651537611800574031959486002303871,
 0.9999496228046825908158980364364363983918323011048979621546547056645122434732231011729214907672371127,
 0.9999757878005822949694321027755676331218323203722969838835394387822835323795583139540936205159177022,
 0.9999883629256767580140585759953781627352468966906202587706247199114154587544063438991830674534624158,
 0.9999944068322023178206669640093393582321943753351667822052425654439085892619767223407660904252647454,
 0.9999973117228546033565495321067285884972113138431684748491296874123701918772776463817906762406339354,
 0.9999987079144637642498983879065431337794011738268649107699270582909097482456339769895636993565751778,
 0.9999993789751380739090818068960910619892966424545800787620508305201463286213496140589946156777322258,
 0.9999997015119507189279611102847251357471768832323989676911903007904906321537829705448283727300581729
 )
 )

E_cdf_df_X3 <- data.frame(
    N = 10^(seq(0, 12, 0.5)),
    cdf = c(
    0.002930701747871698649897545992335660666930738128401668941774236121220896297259999619126206338177221298,
 0.004893754107933388007831910882526772694060690629479710252589944005668497244511977817038828068112412128,
 0.008170551299246745299280481706005800981898523049876105448369673039181385762179033381920239823090160991,
 0.01363744782080988558081239569544335711220433433555504902512773116912854963440214474678702413269937674,
 0.02274835104868065943735452137309210390780433560507801134281413091695759748459860587492862893531052151,
 0.03789804953156154870016656271279884672079095966724733620527841972357535087694978834715035849555844285,
 0.06297169052452575948589803322109527787651361238972489606923817567972041697696525758306623311199894868,
 0.1040709156563731814675660115900540358015610863110684454974452394861562679141552280279927542511641587,
 0.1701133029432595446671466402435814804834339047195957798796724413794464646193131115155626248009501887,
 0.2720452112720361224891015240113914007716785361069539028091700489950402190774995876026506927948630569,
 0.4173379417927871027703358253941617833648755315880626382969837138111056187155203278781671143320516639,
 0.5958551810828237145581031392231567529203125199099087695780537589678027421600309634446012397063879759,
 0.7671448451521610905877060592758902327077284974074217079731687171882629194585523520762067913358784181,
 0.885492438244954123794981233685878991879899863992728201205695441714993712748168673970700896911867121,
 0.9469352794184382931278281910409593212054142462231262605478998761535744608430234036287007628960028984,
 0.9752867701009289780997839896971066035978127932422929896794039125650933258488489646524609744899237172,
 0.9883313532186869704306725188342930983991364986614672978507321569347973280252671947946290422432376644,
 0.9944420277357871525624727823246349188884242435395389961065663802836994822112675456528100330637881511,
 0.9973404513291348374890775605722306091354123534463391920924239732991168020833658296706893077218092564,
 0.9987244681995415438768694195150690365828480052740308370893415768628637726116657262901527800892366437,
 0.9993875675464860928466005558681474123684092060940051320429675387946355674611957678281361817714226001,
 0.9997057889133436243566566436766035468501796675580694725740383529542635744038925717615344973202506517,
 0.9998586249894064736036709412080721482807792617418047999970735498518806622722911482300556673827815644,
 0.9999320576520976347566525638249538703433290375433922939161786183983346868497156346983472130288851182,
 0.9999673461374699763420292537881703786377427136571180441017187247959458156345672591080125664003442642
 )
 )

F_cdf_df_X3 <- data.frame(
    N = 10^(seq(0, 12, 0.5)),
    cdf = c(
    0.4789231231032707232983554157711880319633867950429089971301747640583684788501468169729957473437073129,
 0.5122720963853673766747013188716910660461323706810281661402128889856659760144353346387179926525125822,
 0.5468970162650685006614292081858384311696658211069064375918868682358683010898702234821397018552707089,
 0.5826176487649023525459541890641705177241534372635660630567517069208353115390508372145458009844748002,
 0.6192052506137854349981191704515092842045965941877905416615687757133588828241450238808626682271250124,
 0.6563799434276761524565544869777387417909304219871221356999140557115711360937862465949182655201279965,
 0.6938096261120138925238648163339424292949134587851987595204490045364107928221607770124893577698667057,
 0.731110863366749077690412998531122644395317990706027062482010482163167946453190770029953467539975327,
 0.7678521612021744952383011915843485942220105191777160830647903656512180085885296292914652120915476972,
 0.8035599689444992552457115766701908714708973654477797503021880181091075442816656915195880916032997036,
 0.8377276304595649207156255001502041291049271007005314232073991337065539491016104482217198727823583921,
 0.8698273602766678997350840997181881734375123619022320710911898912296010426313720712408453342551778361,
 0.8993251957334250120383599508296820233960466493414661718856093559228246692754465351691288573595691591,
 0.9256989226777786548633407683553718441672313424724990083901669602239927198800764128957877271150048585,
 0.948459592814790248540756464868819443744583172708024456411878143223397794479462212742479188372139964,
 0.9671795283196059992834660691286489678305513603340383120927508520510381808554605469584707234130268299,
 0.9815364055101939909843311348222132082289427343356952887081568802471800659890448404480900812842268802,
 0.9913997970034096383390760280859709398731917509525265708918156095918441291157430287224282018686572399,
 0.9970145230546386950830421612834345799653602820341066294780753544060153775566081472424464512051806489,
 0.9992983638289456412406487143673574681256772019817279700001093923293495578609686230034806078547818847,
 0.9998503174816701568751693485139139114692474583154954924086459208284072455807052001476671560431182516,
 0.9999552599400175957090338162921049009697062821349220382819227921953340236242176208955871885381829629,
 0.9999849685371531041788989288090388071870543834975463132595923032170334204278471298214030816083512719,
 0.9999948258691136906309378372834619944176858790625395593518382518653351293370650278499001431903093039,
 0.9999982057923270227555387893698993753056572221334027213162813432219246665181013536351913330331778623
 )
 )


G_cdf_df_X3 <- data.frame(
    N = 10^(seq(0, 12, 0.5)),
    cdf = c(
    0.8526724608278199635579459261365156690556930153474625310031772638061458209072900631805155795675268666,
 0.8615267268177151233318427104222681996786405203062008968174422858795552127554949576015252949285439966,
 0.8704730192297771672100833995437198793492963531976794492333109926568607135558033753789230969498100342,
 0.8795122857109387478431820875738857989927055920797806818263808360092247086032639512736145185127597948,
 0.8886454677201495590622592167991824161290607702024605385711919544614281399899156837981131555120690684,
 0.8978734741751174080879202911788116709920784540801183059192211775434138772739253068592226027273513381,
 0.9071971117869538257303723646285334935547963072493156146128084057004306105307331547748568292602840707,
 0.9166169011954504278962029399617250816768715607348119244433991621099175325626333151559277003199373338,
 0.9261325921248956756517994493194935032201425108618714655644136593242168257650029067320094573961635476,
 0.9357418861381657045957136449283137258323410167936268023589921656863662839664350863943449350496263654,
 0.9454370790130293231918650765617528473404689099361399995320106423103050706342908344174249273926524745,
 0.9551962811136732924187672398322387199273629763909105084910761569858799833315347351630339785818881116,
 0.9649607779371128441327483289943007157256594431608171048109493938740971813541307898393407238347435761,
 0.9745787792321218285544557747302734804042906949748836922209621390877241219278983060037664419750820424,
 0.9836793163060911198560523590893650509413466329389378655646810433021171170771150479863829652696024302,
 0.9914682753669257385550337387410436844522490715421879932076157291893042437869034099840009017492690866,
 0.9967513410947522594931669119811969324571012213705994617006891627729265174104597003112674959538141887,
 0.9990610532097524726835450145993847288396206423360465082742756820161580006624284598183639301189157851,
 0.999706738397582224574318497357029905165584006519433258937600254086863393790399716155385703635910289,
 0.9998951429872928450876592709483491128956338694315754963584593885712510028455609054527062324790526121,
 0.9999607762100280951893239414062032600809196223327767451855586443368004226204486785777895157722657143,
 0.999985104668104679504879596618153096479665448258095098953332001206867123534476161161721193578172515,
 0.9999943123196660632675566418110393355112446683180881654176849674039346561856258030973917629956326655,
 0.9999978237113086700501979357200587770393104333403744319540939637984855346070840653879083329812819103,
 0.9999991666282526521332459620647406855637056890250266568426722560727841843608975456710866010120011202
 )
 )


g3 <- ggplot(data = df_all) +
    stat_ecdf(
        mapping = aes(
            x = X_3 + 1, 
            color = setting,
            lty = "Simulation"
        ), 
        geom = "step"
    ) +
    geom_line(
        data = A_cdf_df_X3,
        mapping = aes(x = N, y = cdf, colour = "A", lty = "Theory"),
        linewidth = 1.5
    ) +
    geom_line(
        data = B_cdf_df_X3,
        mapping = aes(x = N, y = cdf, colour = "B", lty = "Theory"),
        linewidth = 1.5
    ) +
    stat_function(
        mapping = aes(
            x = as.numeric(X_2 + 1),
            color = "C", 
            lty = "Theory"),
        fun = function(x) {
            pgamma(
                x * exp(-0.7 * t) / t^2,
                shape = 0.7,
                rate = 0.7 / 0.01 / (0.01 / 2)
            )
        },
        linewidth = 1.5
    ) +
    geom_line(
        data = D_cdf_df_X3,
        mapping = aes(x = N, y = cdf, colour = "D", lty = "Theory"),
        linewidth = 1.5
    ) +
    geom_line(
        data = E_cdf_df_X3,
        mapping = aes(x = N, y = cdf, colour = "E", lty = "Theory"),
        linewidth = 1.5
    ) +
    geom_line(
        data = F_cdf_df_X3,
        mapping = aes(x = N, y = cdf, colour = "F", lty = "Theory"),
        linewidth = 1.5
    ) +
    geom_line(
        data = G_cdf_df_X3,
        mapping = aes(x = N, y = cdf, colour = "G", lty = "Theory"),
        linewidth = 1.5
    ) +
    scale_color_manual(
        values = c(
            "A" = color_palette[1],
            "B" = color_palette[2],
            "C" = color_palette[3],
            "D" = color_palette[4],
            "E" = color_palette[5],
            "F" = color_palette[6],
            "G" = color_palette[7],
            "H" = color_palette[8]
        ),
        labels = c(
            "A" = "A",
            "B" = "B",
            "C" = "C",
            "D" = "D",
            "E" = "E",
            "F" = "F",
            "G" = "G",
            "H" = "H"
        ),
        guide = "legend",
        labs(title = "Setting")
    ) +
    scale_linetype_manual(
        values = c(
            "Simulation" = 1,
            "Theory" = 4
        ),
        labels = c(
            "Simulation",
            "Theory"
        ),
        guide = "legend",
        labs(title = "Method")
    ) +
    labs(
        x = TeX(
            sprintf(
                paste0(
                    "Number of cells ",
                    "($C_3(t)$, t = %s)"
                ),
                t
            )
        ),
        y = "Cumulative probability"
    ) +
    scale_x_log10() +
    theme(
        legend.title = element_text(size = 16),
        legend.text = element_text(size = 14),
        axis.title = element_text(size = 16),
        axis.text = element_text(size = 14),
        plot.title = element_text(size = 16)
    ) +
    coord_cartesian(xlim = c(4, 1e10)) +
    guides(
        color = guide_legend(nrow = 1),   # Keep color legend in one row
        shape = guide_legend(nrow = 1),
        linetype = guide_legend(nrow = 1)
    )


C_sampling <- 1e9

A_F_sampling <- function(t) {
    nu_1 <- 0.7
    alpha_1 <- 1
    beta_1 <- 0.3
    nu_2 <- 0.01
    alpha_2 <- 1
    beta_2 <- 1.5
    nu_3 <- 0.01
    alpha_3 <- 1.4
    beta_3 <- 0.3
    C_sampling <- 1e9

    lambda_1 <- alpha_1 - beta_1
    lambda_2 <- alpha_2 - beta_2
    lambda_3 <- alpha_3 - beta_3

    delta_1 <- lambda_1
    delta_2 <- max(lambda_1, lambda_2)
    delta_3 <- max(lambda_1, lambda_2, lambda_3)

    r_1 <- 1
    r_2 <- sum(c(lambda_1, lambda_2) == delta_2)
    r_3 <- sum(c(lambda_1, lambda_2, lambda_3) == delta_3)

    rho_1 <- nu_1 / alpha_1
    rho_2 <- nu_2 / alpha_2
    rho_3 <- nu_3 / alpha_3

    phi_1 <- alpha_1 / lambda_1
    phi_2 <- -beta_2 / lambda_2
    phi_3 <- alpha_3 / lambda_3

    gamma_1 <- 0
    gamma_2 <- delta_1 / delta_2
    gamma_3 <- delta_2 / delta_3
    q_tilde_3 <- (exp(delta_3 * t) - 1) / delta_3 / C_sampling
    g_tilde_3 <- q_tilde_3

    h_3 <- rho_3 * phi_3^gamma_3 *
        pi / sin(pi * gamma_3) * g_tilde_3^gamma_3
    
    q_tilde_2 <- (exp(delta_2 * t) - 1) / delta_2 / C_sampling
    g_tilde_2 <- q_tilde_2 + h_3
    h_2 <- nu_2 * g_tilde_2 / (delta_1 - lambda_2)

    q_tilde_1 <- (exp(delta_1 * t) - 1) / delta_1 / C_sampling
    g_tilde_1 <- q_tilde_1 + h_2

    return(1 - (1 + phi_1 * g_tilde_1)^(-rho_1))
}

B_F_sampling <- function(t) {
    nu_1 <- 0.7
    alpha_1 <- 1
    beta_1 <- 0.3
    nu_2 <- 0.01
    alpha_2 <- 1.4
    beta_2 <- 0.3
    nu_3 <- 0.01
    alpha_3 <- 1
    beta_3 <- 1.5
    nu_4 <- 0.01
    C_sampling <- 1e9

    lambda_1 <- alpha_1 - beta_1
    lambda_2 <- alpha_2 - beta_2
    lambda_3 <- alpha_3 - beta_3

    delta_1 <- lambda_1
    delta_2 <- max(lambda_1, lambda_2)
    delta_3 <- max(lambda_1, lambda_2, lambda_3)

    r_1 <- 1
    r_2 <- sum(c(lambda_1, lambda_2) == delta_2)
    r_3 <- sum(c(lambda_1, lambda_2, lambda_3) == delta_3)

    rho_1 <- nu_1 / alpha_1
    rho_2 <- nu_2 / alpha_2
    rho_3 <- nu_3 / alpha_3

    phi_1 <- alpha_1 / lambda_1
    phi_2 <- alpha_2 / lambda_2
    phi_3 <- -beta_3 / lambda_3

    gamma_1 <- 0
    gamma_2 <- delta_1 / delta_2
    gamma_3 <- delta_2 / delta_3
    q_tilde_3 <- (exp(delta_3 * t) - 1) / delta_3 / C_sampling
    g_tilde_3 <- q_tilde_3

    h_3 <- nu_3 * g_tilde_3 / (delta_2 - lambda_3)
    
    q_tilde_2 <- (exp(delta_2 * t) - 1) / delta_2 / C_sampling
    g_tilde_2 <- q_tilde_2 + h_3
    h_2 <- rho_2 * phi_2^gamma_2 *
        pi / sin(pi * gamma_2) * g_tilde_2^gamma_2

    q_tilde_1 <- (exp(delta_1 * t) - 1) / delta_1 / C_sampling
    g_tilde_1 <- q_tilde_1 + h_2

    return(1 - (1 + phi_1 * g_tilde_1)^(-rho_1))
}

C_F_sampling <- function(t) {
    nu_1 <- 0.7
    alpha_1 <- 1
    beta_1 <- 0.3
    nu_2 <- 0.01
    alpha_2 <- 1
    beta_2 <- 0.3
    nu_3 <- 0.01
    alpha_3 <- 1
    beta_3 <- 0.3
    nu_4 <- 0.01

    lambda_1 <- alpha_1 - beta_1
    lambda_2 <- alpha_2 - beta_2
    lambda_3 <- alpha_3 - beta_3

    delta_1 <- lambda_1
    delta_2 <- max(delta_1, lambda_2)
    delta_3 <- max(delta_2, lambda_3)

    r_1 <- 1
    r_2 <- sum(c(lambda_1, lambda_2) == delta_2)
    r_3 <- sum(c(lambda_1, lambda_2, lambda_3) == delta_3)

    rho_1 <- nu_1 / alpha_1
    rho_2 <- nu_2 / alpha_2
    rho_3 <- nu_3 / alpha_3

    phi_1 <- alpha_1 / lambda_1
    phi_2 <- alpha_2 / lambda_2
    phi_3 <- alpha_3 / lambda_3

    gamma_1 <- 0
    gamma_2 <- delta_1 / delta_2
    gamma_3 <- delta_2 / delta_3
    q_tilde_3 <- (exp(lambda_3 * t) - 1) / lambda_3 / C_sampling
    g_tilde_3 <- q_tilde_3

    h_3 <- rho_3 * g_tilde_3 / r_2
    
    q_tilde_2 <- (exp(lambda_2 * t) - 1) / lambda_2 / C_sampling
    g_tilde_2 <- q_tilde_2 + h_3
    h_2 <- nu_2 * g_tilde_2 / r_1

    q_tilde_1 <- (exp(lambda_1 * t) - 1) / lambda_1 / C_sampling
    g_tilde_1 <- q_tilde_1 + h_2

    return(1 - (1 + phi_1 * g_tilde_1)^(-rho_1))
}

D_F_sampling <- function(t) {
    nu_1 <- 0.7
    alpha_1 <- 1
    beta_1 <- 0.3
    nu_2 <- 0.001
    alpha_2 <- 1.4
    beta_2 <- 0.3
    nu_3 <- 0.001
    alpha_3 <- 1
    beta_3 <- 1.5
    nu_4 <- 0.001

    lambda_1 <- alpha_1 - beta_1
    lambda_2 <- alpha_2 - beta_2
    lambda_3 <- alpha_3 - beta_3

    delta_1 <- lambda_1
    delta_2 <- max(delta_1, lambda_2)
    delta_3 <- max(delta_2, lambda_3)

    r_1 <- 1
    r_2 <- sum(c(lambda_1, lambda_2) == delta_2)
    r_3 <- sum(c(lambda_1, lambda_2, lambda_3) == delta_3)

    rho_1 <- nu_1 / alpha_1
    rho_2 <- nu_2 / alpha_2
    rho_3 <- nu_3 / alpha_3

    phi_1 <- alpha_1 / lambda_1
    phi_2 <- alpha_2 / lambda_2
    phi_3 <- -beta_3 / lambda_3

    gamma_1 <- 0
    gamma_2 <- delta_1 / delta_2
    gamma_3 <- delta_2 / delta_3
    q_tilde_3 <- (exp(lambda_3 * t) - 1) / lambda_3 / C_sampling
    g_tilde_3 <- q_tilde_3

    h_3 <- nu_3 * g_tilde_3 / (delta_2 - lambda_3)
    
    q_tilde_2 <- (exp(lambda_2 * t) - 1) / lambda_2 / C_sampling
    g_tilde_2 <- q_tilde_2 + h_3
    h_2 <- rho_2 * phi_2^gamma_2 *
        pi / sin(pi * gamma_2) * g_tilde_2^gamma_2

    q_tilde_1 <- (exp(lambda_1 * t) - 1) / lambda_1 / C_sampling
    g_tilde_1 <- q_tilde_1 + h_2

    return(1 - (1 + phi_1 * g_tilde_1)^(-rho_1))
}

E_F_sampling <- function(t) {
    nu_1 <- 0.7
    alpha_1 <- 1
    beta_1 <- 0.3
    nu_2 <- 0.01
    alpha_2 <- 1
    beta_2 <- 1.5
    nu_3 <- 0.001
    alpha_3 <- 1.4
    beta_3 <- 0.3
    C_sampling <- 1e9

    lambda_1 <- alpha_1 - beta_1
    lambda_2 <- alpha_2 - beta_2
    lambda_3 <- alpha_3 - beta_3

    delta_1 <- lambda_1
    delta_2 <- max(delta_1, lambda_2)
    delta_3 <- max(delta_1, lambda_3)

    r_1 <- 1
    r_2 <- sum(c(lambda_1, lambda_2) == delta_2)
    r_3 <- sum(c(lambda_1, lambda_3) == delta_3)

    rho_1 <- nu_1 / alpha_1
    rho_2 <- nu_2 / alpha_2
    rho_3 <- nu_3 / alpha_3

    phi_1 <- alpha_1 / lambda_1
    phi_2 <- -beta_2 / lambda_2
    phi_3 <- alpha_3 / lambda_3

    gamma_1 <- 0
    gamma_2 <- delta_1 / delta_2
    gamma_3 <- delta_1 / delta_3
    q_tilde_3 <- (exp(lambda_3 * t) - 1) / lambda_3 / C_sampling
    g_tilde_3 <- q_tilde_3

    h_3 <- rho_3 * phi_3^gamma_3 *
        pi / sin(pi * gamma_3) * g_tilde_3^gamma_3
    
    q_tilde_2 <- (exp(lambda_2 * t) - 1) / lambda_2 / C_sampling
    g_tilde_2 <- q_tilde_2
    h_2 <- nu_2 * g_tilde_2 / (delta_1 - lambda_2)

    q_tilde_1 <- (exp(lambda_1 * t) - 1) / lambda_1 / C_sampling
    g_tilde_1 <- q_tilde_1 + h_2 + h_3

    return(1 - (1 + phi_1 * g_tilde_1)^(-rho_1))
}

F_F_sampling <- function(t) {
    nu_1 <- 0.7
    alpha_1 <- 0.3
    beta_1 <- 0.3
    nu_2 <- 0.01
    alpha_2 <- 1.4
    beta_2 <- 0.3
    nu_3 <- 0.01
    alpha_3 <- 1.5
    beta_3 <- 0.3

    lambda_1 <- alpha_1 - beta_1
    lambda_2 <- alpha_2 - beta_2
    lambda_3 <- alpha_3 - beta_3

    delta_1 <- lambda_1
    delta_2 <- max(delta_1, lambda_2)
    delta_3 <- max(delta_2, lambda_3)

    r_1 <- 2
    r_2 <- sum(c(lambda_1, lambda_2) == delta_2)
    r_3 <- sum(c(lambda_1, lambda_2, lambda_3) == delta_3)

    rho_1 <- nu_1 / alpha_1
    rho_2 <- nu_2 / alpha_2
    rho_3 <- nu_3 / alpha_3

    phi_1 <- alpha_1
    phi_2 <- alpha_2 / lambda_2
    phi_3 <- alpha_3 / lambda_3

    gamma_1 <- 0
    gamma_2 <- delta_1 / delta_2
    gamma_3 <- delta_2 / delta_3
    q_tilde_3 <- (exp(lambda_3 * t) - 1) / lambda_3 / C_sampling
    g_tilde_3 <- q_tilde_3

    h_3 <- rho_3 * phi_3^gamma_3 *
        pi / sin(pi * gamma_3) * g_tilde_3^gamma_3
    
    q_tilde_2 <- (exp(lambda_2 * t) - 1) / lambda_2 / C_sampling
    g_tilde_2 <- q_tilde_2 + h_3
    h_2 <- -rho_2 / lambda_2 * polylog(-phi_2 * g_tilde_2, r_1)

    q_tilde_1 <- t^2 / 2 / C_sampling
    g_tilde_1 <- q_tilde_1 + h_2

    return(1 - (1 + phi_1 * g_tilde_1)^(-rho_1))
}

G_F_sampling <- function(t, tau = 0.01) {

    nu_1 <- 0.7
    alpha_1 <- 0.7
    beta_1 <- 1.2
    nu_2 <- 0.01
    alpha_2 <- 1.3
    beta_2 <- 0.3
    nu_3 <- 0.01
    alpha_3 <- 1.5
    beta_3 <- 0.3

    lambda_1 <- alpha_1 - beta_1
    lambda_2 <- alpha_2 - beta_2
    lambda_3 <- alpha_3 - beta_3

    delta_1 <- 0
    delta_2 <- max(delta_1, lambda_2)
    delta_3 <- max(delta_2, lambda_3)

    r_1 <- 1
    r_2 <- sum(c(lambda_1, lambda_2) == delta_2)
    r_3 <- sum(c(lambda_1, lambda_2, lambda_3) == delta_3)

    rho_1 <- nu_1 / alpha_1
    rho_2 <- nu_2 / alpha_2
    rho_3 <- nu_3 / alpha_3

    phi_1 <- -beta_1 / lambda_1
    phi_2 <- alpha_2 / lambda_2
    phi_3 <- alpha_3 / lambda_3

    gamma_1 <- 0
    gamma_2 <- delta_1 / delta_2
    # gamma_2 <- -lambda_1 / delta_2
    gamma_3 <- delta_2 / delta_3
    t <- t + 1 / lambda_1
    q_tilde_3 <- (exp(delta_3 * t) - 1) / delta_3 / C_sampling
    g_tilde_3 <- q_tilde_3

    h_3 <- rho_3 * phi_3^gamma_3 *
        pi / sin(pi * gamma_3) * g_tilde_3^gamma_3
    
    q_tilde_2 <- (exp(delta_2 * t) - 1) / delta_2 / C_sampling
    g_tilde_2 <- q_tilde_2 + h_3
    h_2 <- rho_2 * log(1 + phi_2 * g_tilde_2)

    q_tilde_1 <- 1 / C_sampling
    g_tilde_1 <- q_tilde_1 + h_2 / t

    return(1 - (phi_1 + (1 - phi_1) * exp(-g_tilde_1 * tau))^(-rho_1 * t / tau))
}




g4 <- ggplot(na.omit(df_sampling_all)) +
    stat_ecdf(
        mapping = aes(
            x = time, 
            color = setting,
            lty = "Simulation"
        ),
        geom = "step"
    ) +
    stat_function(
        mapping = aes(
            x = as.numeric(time), 
            color = "A",
            lty = "Theory"
        ),
        fun = A_F_sampling,
        linewidth = 1.5
    ) +
    stat_function(
        mapping = aes(
            x = as.numeric(time), 
            color = "B",
            lty = "Theory"
        ),
        fun = B_F_sampling,
        linewidth = 1.5
    ) +
    stat_function(
        mapping = aes(
            x = as.numeric(time), 
            color = "C",
            lty = "Theory"
        ),
        fun = C_F_sampling,
        linewidth = 1.5
    ) +
    stat_function(
        mapping = aes(
            x = as.numeric(time), 
            color = "D",
            lty = "Theory"
        ),
        fun = D_F_sampling,
        linewidth = 1.5
    ) +
    stat_function(
        mapping = aes(
            x = as.numeric(time), 
            color = "E",
            lty = "Theory"
        ),
        fun = E_F_sampling,
        linewidth = 1.5
    ) +
    stat_function(
        mapping = aes(
            x = as.numeric(time), 
            color = "F",
            lty = "Theory"
        ),
        fun = F_F_sampling,
        linewidth = 1.5
    ) +
    stat_function(
        mapping = aes(
            x = as.numeric(time), 
            color = "G",
            lty = "Theory"
        ),
        fun = G_F_sampling,
        linewidth = 1.5
    ) +
    scale_color_manual(
        values = c(
            "A" = color_palette[1],
            "B" = color_palette[2],
            "C" = color_palette[3],
            "D" = color_palette[4],
            "E" = color_palette[5],
            "F" = color_palette[6],
            "G" = color_palette[7],
            "H" = color_palette[8]
        ),
        labels = c(
            "A" = "A",
            "B" = "B",
            "C" = "C",
            "D" = "D",
            "E" = "E",
            "F" = "F",
            "G" = "G",
            "H" = "H"
        ),
        guide = "legend",
        labs(title = "Setting")
    ) +
    scale_linetype_manual(
        values = c(
            "Simulation" = 1,
            "Theory" = 4
        ),
        labels = c(
            "Simulation",
            "Theory"
        ),
        guide = "legend",
        labs(title = "Method")
    ) +
    labs(
        x = "Sampling time (t)",
        y = "Cumulative probability"
    ) +
    coord_cartesian(xlim = c(min(df_sampling_all$time), 46)) +
    scale_x_log10() +
    theme(
        legend.title = element_text(size = 16),
        legend.text = element_text(size = 14),
        axis.title = element_text(size = 16),
        axis.text = element_text(size = 14),
        plot.title = element_text(size = 16)
    ) +
    guides(
        color = guide_legend(nrow = 1),   # Keep color legend in one row
        shape = guide_legend(nrow = 1),
        linetype = guide_legend(nrow = 1)
    )

G <- ggarrange(g1, g2, g3, g4, ncol = 2, nrow = 2, common.legend = TRUE, legend = "bottom")

G <- ggarrange(
    g1, 
    g2 + theme(axis.title.y = element_blank()),
    g3 + theme(axis.title.y = element_blank()),
    g4 + theme(axis.title.y = element_blank()),
    ncol = 4, nrow = 1, common.legend = TRUE, legend = "bottom")

G <- ggarrange(
    g1 + labs(y = "CDF"),
    g2 + labs(y = "CDF"),
    g3 + labs(y = "CDF"),
    g4 + labs(y = "CDF"),
    ncol = 2, nrow = 2, common.legend = TRUE, legend = "bottom"
)

# G <- annotate_figure(
#   G,
#   top = text_grob("Subclonal population and sampling time distributions", color = "black", size = 16)
# )

ggsave(
    filename = "/Users/luox/Documents/Projects/FiTree/figures/simulation_I_aggregated.pdf",
    plot = G,
    width = 8,
    height = 6
)
